<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·ª£ l√Ω T∆∞ v·∫•n H·ªá th·ªëng Ch·∫•m ƒëi·ªÉm</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .chat-container {
            max-width: 800px;
            height: 85vh; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho chatbox */
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        #chatDisplay {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        #userInputContainer {
            padding: 1rem;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 0.75rem 0.75rem;
        }
        .message-user {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            border-radius: 0.75rem 0.75rem 0 0.75rem;
        }
        .message-bot {
            background-color: #e5e7eb; /* Gray 200 */
            color: #1f2937; /* Gray 800 */
            border-radius: 0.75rem 0.75rem 0.75rem 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

<div class="chat-container w-full rounded-xl">

    <!-- Header -->
    <div class="p-4 bg-blue-600 text-white rounded-t-xl text-center">
        <h1 class="text-xl font-bold">Tr·ª£ l√Ω T∆∞ v·∫•n H·ªá th·ªëng Ch·∫•m ƒëi·ªÉm</h1>
        <p class="text-sm opacity-80">H·ªèi v·ªÅ Auto Grading, Semantic Evaluation, BERTScore, Sentence-BERT, v.v.</p>
    </div>

    <!-- Khu v·ª±c hi·ªÉn th·ªã chat -->
    <div id="chatDisplay">
        <!-- Tin nh·∫Øn ch√†o m·ª´ng -->
        <div class="flex justify-start mb-4">
            <div class="max-w-xs md:max-w-md p-3 message-bot">
                Ch√†o b·∫°n! T√¥i l√† tr·ª£ l√Ω t∆∞ v·∫•n cho h·ªá th·ªëng ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông c·ªßa b·∫°n. T√¥i c√≥ th·ªÉ gi·∫£i th√≠ch v·ªÅ **BERTScore**, **Sentence-BERT** hay c√°ch **Microservice ch·∫•m ƒëi·ªÉm/feedback** ho·∫°t ƒë·ªông. B·∫°n mu·ªën h·ªèi g√¨?
            </div>
        </div>
    </div>

    <!-- Khu v·ª±c nh·∫≠p li·ªáu -->
    <div id="userInputContainer" class="flex items-center">
        <input type="text" id="userInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
               class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 mr-3">
        <button id="sendButton" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center">
            <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
            <div id="loadingSpinner" class="spinner hidden"></div>
        </button>
    </div>
</div>

<script>
    // Kh√≥a API ƒë∆∞·ª£c hardcode ƒë·ªÉ s·ª≠ d·ª•ng cho m·ª•c ƒë√≠ch ph√°t tri·ªÉn c·ª•c b·ªô khi __initial_gemini_api_key kh√¥ng t·ªìn t·∫°i.
    const HARDCODED_API_KEY = "AIzaSyDQriDXZlI6XNVn91cyoFUyz1xSkBhJ0VA";

    // L·∫•y API Key: ∆Øu ti√™n bi·∫øn m√¥i tr∆∞·ªùng Canvas, n·∫øu kh√¥ng c√≥ th√¨ d√πng kh√≥a hardcode.
    let apiKey = (typeof __initial_gemini_api_key !== 'undefined')
        ? __initial_gemini_api_key
        : HARDCODED_API_KEY;

    let apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const chatDisplay = document.getElementById('chatDisplay');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const sendIcon = document.getElementById('sendIcon');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Lo·∫°i b·ªè c√°c bi·∫øn li√™n quan ƒë·∫øn giao di·ªán nh·∫≠p/l∆∞u/x√≥a API Key c≈©
    // const apiKeySetup = document.getElementById('apiKeySetup');
    // const localApiKeyInput = document.getElementById('localApiKeyInput');
    // const saveApiKeyButton = document.getElementById('saveApiKeyButton');
    // const deleteApiKeyButton = document.getElementById('deleteApiKeyButton');
    // const apiKeyStatus = document.getElementById('apiKeyStatus');

    let chatHistory = [];

    // --- Logic qu·∫£n l√Ω API Key cho m√¥i tr∆∞·ªùng c·ª•c b·ªô (ƒë√£ lo·∫°i b·ªè) ---
    // C√°c h√†m checkApiKeyStatus, saveApiKeyButton.addEventListener, deleteLocalApiKey ƒë√£ b·ªã x√≥a.

    // H√†m th√™m tin nh·∫Øn v√†o giao di·ªán
    function appendMessage(sender, text) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

        const messageBubble = document.createElement('div');
        messageBubble.className = `max-w-xs md:max-w-md p-3 shadow-md text-sm ${sender === 'user' ? 'message-user' : 'message-bot'}`;

        // X·ª≠ l√Ω markdown ƒë∆°n gi·∫£n cho ph·∫£n h·ªìi c·ªßa bot
        let htmlText = text;
        if (sender === 'bot') {
            // Chuy·ªÉn ƒë·ªïi in ƒë·∫≠m
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Chuy·ªÉn ƒë·ªïi d√≤ng m·ªõi th√†nh <br>
            htmlText = htmlText.replace(/\n/g, '<br>');
        }

        messageBubble.innerHTML = htmlText;
        messageWrapper.appendChild(messageBubble);
        chatDisplay.appendChild(messageWrapper);
        chatDisplay.scrollTop = chatDisplay.scrollHeight; // Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
    }

    // H√†m x·ª≠ l√Ω vi·ªác g·ª≠i tin nh·∫Øn
    async function sendMessage() {
        const userMessage = userInput.value.trim();

        if (!userMessage) return;

        // Ki·ªÉm tra API Key: n·∫øu kh√¥ng c√≥ kh√≥a n√†o (c·∫£ t·ª´ Canvas v√† hardcoded) th√¨ b√°o l·ªói
        if (!apiKey) {
            appendMessage('bot', 'üõë L·ªói c·∫•u h√¨nh: Kh√¥ng t√¨m th·∫•y Gemini API Key. Vui l√≤ng ki·ªÉm tra l·∫°i m√£ ngu·ªìn.');
            return;
        }

        // 1. Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
        appendMessage('user', userMessage);

        // 2. Th√™m v√†o l·ªãch s·ª≠ chat
        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

        // 3. X√≥a input v√† v√¥ hi·ªáu h√≥a n√∫t
        userInput.value = '';
        sendButton.disabled = true;
        sendIcon.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        // 4. T·∫°o tin nh·∫Øn loading cho bot
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'flex justify-start mb-4';
        loadingMessage.innerHTML = `<div id="botLoading" class="p-3 message-bot shadow-md text-sm"><div class="spinner"></div> ƒêang t√¨m ki·∫øm...</div>`;
        chatDisplay.appendChild(loadingMessage);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;

        try {
            // ƒê·ªãnh nghƒ©a System Instruction
            const systemPrompt = `B·∫°n l√† Tr·ª£ l√Ω T∆∞ v·∫•n K·ªπ thu·∫≠t cho H·ªá th·ªëng Ch·∫•m ƒëi·ªÉm T·ª± ƒë·ªông. Nhi·ªám v·ª• c·ªßa b·∫°n l√† gi·∫£i th√≠ch c√°c kh√°i ni·ªám k·ªπ thu·∫≠t nh∆∞ BERTScore, Sentence-BERT, Semantic Evaluation v√† ch·ª©c nƒÉng c·ªßa Microservice ch·∫•m ƒëi·ªÉm/feedback. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.`;

            // Chu·∫©n b·ªã Payload cho API
            const payload = {
                contents: chatHistory,
                // S·ª≠ d·ª•ng Google Search Grounding ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c c·ªßa th√¥ng tin k·ªπ thu·∫≠t
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // 5. Th·ª±c hi·ªán g·ªçi API v·ªõi Exponential Backoff
            const maxRetries = 3;
            let botResponseText = "Xin l·ªói, ƒë√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.";
            let lastError = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        // Th√™m th√¥ng tin l·ªói 403 c·ª• th·ªÉ ƒë·ªÉ d·ªÖ debug
                        const errorDetail = (response.status === 403) ? "L·ªói 403: API Key kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu quy·ªÅn." : `API call failed with status ${response.status}`;
                        throw new Error(errorDetail);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        botResponseText = candidate.content.parts[0].text;
                        break; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
                    }
                    throw new Error("API response structure is invalid or content is missing.");

                } catch (error) {
                    lastError = error;
                    console.error(`L·ªói l·∫ßn th·ª≠ ${i + 1}:`, error);
                    if (i < maxRetries - 1) {
                        // √Åp d·ª•ng Exponential Backoff
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // N·∫øu t·∫•t c·∫£ c√°c l·∫ßn th·ª≠ ƒë·ªÅu th·∫•t b·∫°i
            if (botResponseText === "Xin l·ªói, ƒë√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.") {
                botResponseText = `Xin l·ªói, kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn d·ªãch v·ª•. Vui l√≤ng th·ª≠ l·∫°i sau. (L·ªói: ${lastError ? lastError.message : 'Kh√¥ng r√µ'})`;
            }

            // 6. X√≥a tin nh·∫Øn loading
            const loadingDiv = document.getElementById('botLoading');
            if (loadingDiv) loadingDiv.parentElement.remove();

            // 7. Hi·ªÉn th·ªã tin nh·∫Øn ph·∫£n h·ªìi
            appendMessage('bot', botResponseText);

            // 8. C·∫≠p nh·∫≠t l·ªãch s·ª≠ chat v·ªõi ph·∫£n h·ªìi c·ªßa bot
            chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });

        } catch (error) {
            console.error("L·ªói x·ª≠ l√Ω chat:", error);
            // Hi·ªÉn th·ªã l·ªói cu·ªëi c√πng
            const loadingDiv = document.getElementById('botLoading');
            if (loadingDiv) loadingDiv.parentElement.remove();
            appendMessage('bot', `ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng: ${error.message}. Vui l√≤ng ki·ªÉm tra console.`);
        } finally {
            // 9. Ph·ª•c h·ªìi tr·∫°ng th√°i
            sendButton.disabled = false;
            sendIcon.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            userInput.focus();
        }
    }

    // G·∫Øn s·ª± ki·ªán cho n√∫t G·ª≠i
    sendButton.addEventListener('click', sendMessage);

    // G·∫Øn s·ª± ki·ªán cho ph√≠m Enter
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // NgƒÉn h√†nh vi xu·ªëng d√≤ng m·∫∑c ƒë·ªãnh
            sendMessage();
        }
    });

    // T·ª± ƒë·ªông focus v√†o input khi t·∫£i trang
    window.onload = () => {
        userInput.focus();
    };
</script>

</body>
</html>
