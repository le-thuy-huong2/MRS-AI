<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý Tư vấn Hệ thống</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            background-image: url("Screenshot_20250618_200427_Drive.jpg");
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-position: top;
            background-size: 75px 75px;
        }
        .chat-container {
            max-width: 800px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        #chatDisplay {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        #userInputContainer {
            padding: 1rem;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 0.75rem 0.75rem;
        }
        .message-user {
            background-color: #FF9933; /* Blue 600 */
            color: white;
            border-radius: 0.75rem 0.75rem 0 0.75rem;
        }
        .message-bot {
            background-color: #e5e7eb; /* Gray 200 */
            color: #1f2937; /* Gray 800 */
            border-radius: 0.75rem 0.75rem 0.75rem 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style cho nút Tải file */
        .file-input-label {
            cursor: pointer;
            transition: all 0.15s;
        }
        .file-input-label:hover {
            color: #1d4ed8; /* Blue 700 */
        }
        </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

<div class="chat-container w-full rounded-xl">

    <!-- Header -->
    <div class="p-4 bg-orange-600 text-white rounded-t-xl text-center">
        <h1 class="text-xl font-bold">MRS AI</h1>
        <p class="text-sm opacity-80">Kết nối nhanh – Giải đáp chuẩn – Trải nghiệm thông minh cùng MRS AI</p>
    </div>

    <!-- Khu vực hiển thị chat -->
    <div id="chatDisplay">
        <!-- Tin nhắn chào mừng -->
        <div class="flex justify-start mb-4">
            <div class="max-w-xs md:max-w-md p-3 message-bot">
                Chào bạn! Rất vui được nói chuyện với bạn. Bạn muốn mình giúp gì hôm nay?
            </div>
        </div>
    </div>

    <!-- Khu vực hiển thị ảnh đã tải lên -->
    <div id="imagePreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3">
                <img id="imagePreview" class="h-10 w-10 object-cover rounded-md" src="" alt="Ảnh tải lên">
                <span class="text-sm text-gray-700 font-medium">Ảnh đã tải lên</span>
            </div>
            <button id="removeImageButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Khu vực hiển thị audio đã tải lên (MỚI) -->
    <div id="audioPreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3 w-full">
                <audio id="audioPreview" controls class="flex-grow h-10"></audio>
            </div>
            <button id="removeAudioButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors ml-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>


    <!-- Khu vực nhập liệu -->
    <div id="userInputContainer" class="flex items-end">
        <!-- Nút Tải ảnh -->
        <div class="p-3">
            <input type="file" id="imageInput" accept="image/*" class="hidden">
            <label for="imageInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center">
                <!-- Icon Tải ảnh (Clip giấy) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13.5" />
                </svg>
            </label>
        </div>

        <!-- Nút Tải Audio (MỚI) -->
        <div class="p-3">
            <input type="file" id="audioInput" accept="audio/*" class="hidden">
            <label for="audioInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center">
                <!-- Icon Micro/Audio -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7v1a3 3 0 01-6 0v-1a7 7 0 01-7-7h1a6 6 0 0012 0h1z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18V3" />
                </svg>
            </label>
        </div>

        <input type="text" id="userInput" placeholder="Nhập câu hỏi của bạn..."
               class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">

        <button id="sendButton" class="ml-3 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center">
            <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
            <div id="loadingSpinner" class="spinner hidden"></div>
        </button>
    </div>
</div>

<script>
    // KHÓA API CUNG CẤP BỞI NGƯỜI DÙNG.
    // LƯU Ý: Việc hardcode API Key không được khuyến nghị vì lý do bảo mật,
    // nhưng được thực hiện theo yêu cầu rõ ràng của người dùng.
    const USER_PROVIDED_API_KEY = "AIzaSyDQriDXZlI6XNVn91cyoFUyz1xSkBhJ0VA";

    // Lấy API Key: Ưu tiên biến môi trường Canvas, nếu không có thì dùng khóa do người dùng cung cấp.
    let apiKey = (typeof __initial_gemini_api_key !== 'undefined')
        ? __initial_gemini_api_key
        : USER_PROVIDED_API_KEY; // Sử dụng khóa do người dùng cung cấp.

    let apiUrl = apiKey
        ? `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`
        : null;

    // Lấy các phần tử DOM
    const chatDisplay = document.getElementById('chatDisplay');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const sendIcon = document.getElementById('sendIcon');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Phần tử Ảnh
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImageButton = document.getElementById('removeImageButton');

    // Phần tử Audio (MỚI)
    const audioInput = document.getElementById('audioInput');
    const audioPreviewContainer = document.getElementById('audioPreviewContainer');
    const audioPreview = document.getElementById('audioPreview');
    const removeAudioButton = document.getElementById('removeAudioButton');


    let chatHistory = [];
    let uploadedImage = {
        data: null,
        mimeType: null,
        url: null // Dùng để hiển thị preview
    };
    // Biến trạng thái cho Audio (MỚI)
    let uploadedAudio = {
        data: null,
        mimeType: null,
        url: null
    };

    /**
     * Chuyển đổi Blob/File thành chuỗi Base64.
     * @param {File} file - File ảnh hoặc audio được tải lên.
     * @returns {Promise<string>} Chuỗi Base64 data (chỉ data, không có prefix).
     */
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                // Loại bỏ phần prefix "data:image/jpeg;base64," hoặc "data:audio/mp3;base64,"
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // --- LOGIC XỬ LÝ ẢNH ---

    /**
     * Hàm xử lý khi người dùng chọn ảnh
     */
    imageInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            console.error('Vui lòng chọn một file hình ảnh.');
            return;
        }

        // Giới hạn kích thước file (ví dụ: 5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            appendMessage('bot', 'Lỗi: Kích thước file ảnh quá lớn (tối đa 5MB).');
            return;
        }

        try {
            // Xóa file audio nếu đang có
            removeAudioButton.click();

            const base64Data = await fileToBase64(file);
            const imageUrl = URL.createObjectURL(file);

            uploadedImage.data = base64Data;
            uploadedImage.mimeType = file.type;
            uploadedImage.url = imageUrl;

            imagePreview.src = imageUrl;
            imagePreviewContainer.classList.remove('hidden');
            userInput.focus();

        } catch (error) {
            console.error("Lỗi khi chuyển đổi ảnh:", error);
            appendMessage('bot', 'Lỗi: Không thể tải ảnh. Vui lòng kiểm tra kích thước và định dạng.');
            e.target.value = null;
        }
    });

    /**
     * Hàm xóa ảnh đã tải lên
     */
    removeImageButton.addEventListener('click', function() {
        if (uploadedImage.url) {
            URL.revokeObjectURL(uploadedImage.url); // Giải phóng bộ nhớ
        }
        uploadedImage.data = null;
        uploadedImage.mimeType = null;
        uploadedImage.url = null;
        imageInput.value = null; // Reset input file
        imagePreviewContainer.classList.add('hidden');
    });

    // --- LOGIC XỬ LÝ AUDIO ---

    /**
     * Hàm xử lý khi người dùng chọn audio
     */
    audioInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('audio/')) {
            console.error('Vui lòng chọn một file audio.');
            return;
        }

        // Giới hạn kích thước file audio (ví dụ: 10MB cho audio)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            appendMessage('bot', 'Lỗi: Kích thước file audio quá lớn (tối đa 10MB).');
            return;
        }

        try {
            // Xóa file ảnh nếu đang có
            removeImageButton.click();

            const base64Data = await fileToBase64(file);
            const audioUrl = URL.createObjectURL(file);

            uploadedAudio.data = base64Data;
            uploadedAudio.mimeType = file.type;
            uploadedAudio.url = audioUrl;

            audioPreview.src = audioUrl;
            audioPreviewContainer.classList.remove('hidden');
            userInput.focus();

        } catch (error) {
            console.error("Lỗi khi chuyển đổi audio:", error);
            appendMessage('bot', 'Lỗi: Không thể tải audio. Vui lòng kiểm tra kích thước và định dạng.');
            e.target.value = null;
        }
    });

    /**
     * Hàm xóa audio đã tải lên
     */
    removeAudioButton.addEventListener('click', function() {
        if (uploadedAudio.url) {
            URL.revokeObjectURL(uploadedAudio.url); // Giải phóng bộ nhớ
        }
        uploadedAudio.data = null;
        uploadedAudio.mimeType = null;
        uploadedAudio.url = null;
        audioInput.value = null; // Reset input file
        audioPreview.pause(); // Dừng phát nhạc
        audioPreviewContainer.classList.add('hidden');
    });

    // --- LOGIC HIỂN THỊ VÀ GỬI TIN NHẮN ---

    /**
     * Hàm hiển thị nội dung media (nếu có) trong tin nhắn.
     * @param {object[]} parts - Mảng các phần nội dung (text, inlineData).
     * @returns {string} HTML string chứa ảnh, audio (hoặc text đã được format).
     */
    function processMessageParts(parts, sender) {
        let htmlContent = '';
        for (const part of parts) {
            if (part.text) {
                let text = part.text;
                if (sender === 'bot') {
                    // Xử lý markdown đơn giản cho phản hồi của bot
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/\n/g, '<br>');
                }
                htmlContent += text;
            } else if (part.inlineData) {
                const mimeType = part.inlineData.mimeType;
                const base64Data = part.inlineData.data;
                const fileUrl = `data:${mimeType};base64,${base64Data}`;

                if (mimeType.startsWith('image/')) {
                    // Hiển thị ảnh
                    htmlContent += `<img src="${fileUrl}" alt="Uploaded Image" class="max-w-full h-auto max-h-48 object-contain rounded-lg my-2 border border-gray-300 shadow-md">`;
                } else if (mimeType.startsWith('audio/')) {
                    // Hiển thị audio
                    htmlContent += `<audio controls src="${fileUrl}" class="w-full my-2 rounded-lg"></audio>`;
                }
            }
        }
        return htmlContent;
    }

    /**
     * Hàm thêm tin nhắn vào giao diện
     * @param {string} sender - 'user' hoặc 'bot'
     * @param {string | object[]} content - Nội dung văn bản hoặc mảng parts
     */
    function appendMessage(sender, content) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

        const messageBubble = document.createElement('div');
        messageBubble.className = `max-w-xs md:max-w-md p-3 shadow-md text-sm ${sender === 'user' ? 'message-user' : 'message-bot'}`;

        if (typeof content === 'string') {
            // Tin nhắn chào mừng hoặc lỗi
            messageBubble.innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        } else if (Array.isArray(content)) {
            // Tin nhắn từ lịch sử chat (bao gồm cả ảnh/audio)
            messageBubble.innerHTML = processMessageParts(content, sender);
        }

        messageWrapper.appendChild(messageBubble);
        chatDisplay.appendChild(messageWrapper);
        chatDisplay.scrollTop = chatDisplay.scrollHeight; // Cuộn xuống tin nhắn mới nhất
    }


    /**
     * Hàm xử lý việc gửi tin nhắn và gọi API Gemini
     */
    async function sendMessage() {
        const userMessage = userInput.value.trim();

        // Kiểm tra xem có tin nhắn, ảnh, hoặc audio nào không
        if (!userMessage && !uploadedImage.data && !uploadedAudio.data) return;

        // 1. Kiểm tra API Key và URL
        if (!apiKey || !apiUrl) {
            appendMessage('bot', '🛑 Lỗi cấu hình: Không tìm thấy Gemini API Key. Vui lòng kiểm tra lại cấu hình.');
            return;
        }

        // --- Chuẩn bị Nội dung cho API ---
        const userParts = [];

        // Thêm text vào parts nếu có
        if (userMessage) {
            userParts.push({ text: userMessage });
        }

        // Thêm ảnh vào parts nếu có
        if (uploadedImage.data && uploadedImage.mimeType) {
            userParts.push({
                inlineData: {
                    mimeType: uploadedImage.mimeType,
                    data: uploadedImage.data
                }
            });
        }

        // Thêm audio vào parts nếu có
        if (uploadedAudio.data && uploadedAudio.mimeType) {
            userParts.push({
                inlineData: {
                    mimeType: uploadedAudio.mimeType,
                    data: uploadedAudio.data
                }
            });
        }

        // 2. Hiển thị tin nhắn người dùng (có thể bao gồm ảnh/audio)
        appendMessage('user', userParts);

        // 3. Cập nhật lịch sử chat
        chatHistory.push({ role: "user", parts: userParts });

        // 4. Reset giao diện sau khi gửi
        userInput.value = '';
        removeImageButton.click(); // Xóa ảnh đã tải lên
        removeAudioButton.click(); // Xóa audio đã tải lên
        sendButton.disabled = true;
        sendIcon.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        // 5. Tạo tin nhắn loading cho bot
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'flex justify-start mb-4';
        const loadingDivId = 'botLoading-' + Date.now();
        loadingMessage.innerHTML = `<div id="${loadingDivId}" class="p-3 message-bot shadow-md text-sm"><div class="spinner"></div> Đang phân tích...</div>`;
        chatDisplay.appendChild(loadingMessage);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;

        try {
            // Định nghĩa System Instruction
            const systemPrompt = ``;

            // Chuẩn bị Payload cho API
            const payload = {
                contents: chatHistory,
                // Sử dụng Google Search Grounding để đảm bảo độ chính xác của thông tin kỹ thuật
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // 6. Thực hiện gọi API với Exponential Backoff
            const maxRetries = 3;
            let botResponseText = "Xin lỗi, đã xảy ra lỗi không xác định.";
            let lastError = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorDetail = `API call failed with status ${response.status}. Error: ${errorData.error ? errorData.error.message : 'Unknown'}`;
                        throw new Error(errorDetail);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        botResponseText = candidate.content.parts[0].text;
                        break;
                    }
                    throw new Error("API response structure is invalid or content is missing.");

                } catch (error) {
                    lastError = error;
                    console.error(`Lỗi lần thử ${i + 1}:`, error.message);
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (botResponseText === "Xin lỗi, đã xảy ra lỗi không xác định.") {
                botResponseText = `Xin lỗi, không thể kết nối đến dịch vụ sau ${maxRetries} lần thử. Vui lòng thử lại sau. (Lỗi cuối cùng: ${lastError ? lastError.message : 'Không rõ'})`;
            }

            // 7. Xóa tin nhắn loading
            const loadingDiv = document.getElementById(loadingDivId);
            if (loadingDiv) loadingDiv.parentElement.remove();

            // 8. Hiển thị tin nhắn phản hồi
            appendMessage('bot', botResponseText);

            // 9. Cập nhật lịch sử chat với phản hồi của bot
            chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });

        } catch (error) {
            console.error("Lỗi xử lý chat nghiêm trọng:", error);
            const loadingDiv = document.getElementById(loadingDivId);
            if (loadingDiv) loadingDiv.parentElement.remove();
            appendMessage('bot', `Đã xảy ra lỗi nghiêm trọng: ${error.message}. Vui lòng kiểm tra console.`);
        } finally {
            // 10. Phục hồi trạng thái
            sendButton.disabled = false;
            sendIcon.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            userInput.focus();
        }
    }

    // Gắn sự kiện cho nút Gửi
    sendButton.addEventListener('click', sendMessage);

    // Gắn sự kiện cho phím Enter
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // Tự động focus vào input khi tải trang
    window.onload = () => {
        userInput.focus();
    };
</script>

</body>
</html>
