<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRS AI - Multi-Media Grader & Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        h1 {
            color: #003366;
        }
        p{
            color: #003366;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            /* ·∫¢nh n·ªÅn ƒë∆∞·ª£c gi·ªØ l·∫°i t·ª´ y√™u c·∫ßu g·ªëc */
            background-image: url("Screenshot_20250618_200427_Drive.jpg");
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-position: center top;
            background-size: 120px 60px;
        }
        .chat-container {
            max-width: 800px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        #chatDisplay {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        #userInputContainer {
            padding: 1rem;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 0.75rem 0.75rem;
        }
        .message-user {
            background-color: #FF9933; /* Orange 600 */
            color: white;
            border-radius: 0.75rem 0.75rem 0 0.75rem;
        }
        .message-bot {
            background-color: #EEEEEE; /* Gray 200 */
            color: #666666; /* Gray 800 */
            border-radius: 0.75rem 0.75rem 0.75rem 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style cho n√∫t T·∫£i file */
        .file-input-label {
            cursor: pointer;
            transition: all 0.15s;
        }
        .file-input-label:hover {
            color: #1d4ed8; /* Blue 700 */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

<div class="chat-container w-full rounded-xl">

    <div class="p-4 bg-orange-600 text-white rounded-t-xl text-center">
        <h1 class="text-xl font-bold" >MRS AI</h1>
        <p class="text-sm opacity-80">K·∫øt n·ªëi nhanh ‚Äì Gi·∫£i ƒë√°p chu·∫©n ‚Äì Tr·∫£i nghi·ªám th√¥ng minh c√πng MRS AI</p>
    </div>

    <div id="chatDisplay">
        <div class="flex justify-start mb-4">
            <div class="max-w-xs md:max-w-md p-3 message-bot">
                Ch√†o b·∫°n! T√¥i l√† **MRS AI**, tr·ª£ l√Ω ch·∫•m ƒëi·ªÉm media v√† gi·∫£i ƒë√°p th√¥ng minh. H√£y t·∫£i l√™n ·∫£nh/audio ho·∫∑c ƒë·∫∑t c√¢u h·ªèi cho t√¥i!
            </div>
        </div>
    </div>
    <div id="imagePreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3 w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span id="imageFileName" class="text-sm text-gray-700 font-medium truncate flex-grow">ƒê√£ t·∫£i l√™n 0 ·∫£nh</span>
            </div>
            <button id="removeImageButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div id="audioPreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3 w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6a2 2 0 00-2-2H5a2 2 0 00-2 2v13a2 2 0 002 2h4a2 2 0 002-2zm0 0V8a2 2 0 012-2h2a2 2 0 012 2v11a2 2 0 01-2 2h-2a2 2 0 01-2-2zm0 0v-6a2 2 0 012-2h2a2 2 0 012 2v5a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span id="audioFileName" class="text-sm text-gray-700 font-medium truncate flex-grow">ƒê√£ t·∫£i l√™n 0 audio</span>
            </div>
            <button id="removeAudioButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors ml-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>


    <div id="templatePreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3 w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span id="templateFileName" class="text-sm text-gray-700 font-medium truncate flex-grow">ƒê√£ t·∫£i l√™n 0 file</span>
            </div>
            <button id="removeTemplateButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors ml-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div id="userInputContainer" class="flex items-end">

        <div class="p-3">
            <input type="file" id="templateInput" accept=".txt,.json,.pdf,audio/*,image/*" class="hidden" multiple>
            <label for="templateInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center" title="T·∫£i l√™n t·ªáp (ƒëa nƒÉng)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </label>
        </div>

        <div class="p-3">
            <input type="file" id="imageInput" accept="image/*" class="hidden" multiple>
            <label for="imageInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center" title="T·∫£i l√™n ·∫£nh">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13.5" />
                </svg>
            </label>
        </div>

        <div class="p-3">
            <input type="file" id="audioInput" accept="audio/*" class="hidden" multiple>
            <label for="audioInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center" title="T·∫£i l√™n audio">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7v1a3 3 0 01-6 0v-1a7 7 0 01-7-7h1a6 6 0 0012 0h1z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18V3" />
                </svg>
            </label>
        </div>

        <button id="exportButton" class="ml-3 p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center" title="Xu·∫•t L·ªãch s·ª≠ Chat ra file CSV">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        </button>

        <input type="text" id="userInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
               class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">

        <button id="sendButton" class="ml-3 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center">
            <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
            <div id="loadingSpinner" class="spinner hidden"></div>
        </button>
    </div>
</div>

<script>
    // KH√ìA API CUNG C·∫§P B·ªûI NG∆Ø·ªúI D√ôNG. (THAY TH·∫æ B·∫∞NG KH√ìA C·ª¶A B·∫†N N·∫æU C√ì)
    const USER_PROVIDED_API_KEY = "AIzaSyDQriDXZlI6XNVn91cyoFUyz1xSkBhJ0VA";

    // L·∫•y API Key: ∆Øu ti√™n bi·∫øn m√¥i tr∆∞·ªùng Canvas, n·∫øu kh√¥ng c√≥ th√¨ d√πng kh√≥a do ng∆∞·ªùi d√πng cung c·∫•p.
    let apiKey = (typeof __initial_gemini_api_key !== 'undefined')
        ? __initial_gemini_api_key
        : USER_PROVIDED_API_KEY;

    let apiUrl = apiKey
        ? `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`
        : null;

    // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
    const chatDisplay = document.getElementById('chatDisplay');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const sendIcon = document.getElementById('sendIcon');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const exportButton = document.getElementById('exportButton'); // N√∫t Export CSV M·ªöI

    // Ph·∫ßn t·ª≠ ·∫¢nh (ƒê√É N√ÇNG C·∫§P ƒêA T·ªÜP)
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imageFileName = document.getElementById('imageFileName');
    const removeImageButton = document.getElementById('removeImageButton');

    // Ph·∫ßn t·ª≠ Audio (ƒê√É N√ÇNG C·∫§P ƒêA T·ªÜP)
    const audioInput = document.getElementById('audioInput');
    const audioPreviewContainer = document.getElementById('audioPreviewContainer');
    const audioFileName = document.getElementById('audioFileName');
    const removeAudioButton = document.getElementById('removeAudioButton');

    // PH·∫¶N T·ª¨ M·ªöI CHO FILE ƒê·ªäNH D·∫†NG (TEMPLATE - ƒê√É N√ÇNG C·∫§P ƒêA T·ªÜP)
    const templateInput = document.getElementById('templateInput');
    const templatePreviewContainer = document.getElementById('templatePreviewContainer');
    const templateFileName = document.getElementById('templateFileName');
    const removeTemplateButton = document.getElementById('removeTemplateButton');

    let chatHistory = [];
    let uploadedImage = [];
    let uploadedAudio = [];
    let uploadedTemplate = [];

    /**
     * Chuy·ªÉn ƒë·ªïi Blob/File th√†nh chu·ªói Base64.
     */
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    /**
     * H√†m hi·ªÉn th·ªã n·ªôi dung media (n·∫øu c√≥) trong tin nh·∫Øn.
     */
    function processMessageParts(parts, sender) {
        let htmlContent = '';
        for (const part of parts) {
            if (part.text) {
                let text = part.text;
                if (sender === 'bot') {
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/\n/g, '<br>');
                }
                htmlContent += text;
            } else if (part.inlineData) {
                const mimeType = part.inlineData.mimeType;
                const fileUrl = `data:${mimeType};base64,${part.inlineData.data}`;

                if (mimeType.startsWith('image/')) {
                    htmlContent += `<img src="${fileUrl}" alt="Uploaded Image" class="max-w-full h-auto max-h-48 object-contain rounded-lg my-2 border border-gray-300 shadow-md">`;
                } else if (mimeType.startsWith('audio/')) {
                    htmlContent += `<audio controls src="${fileUrl}" class="w-full my-2 rounded-lg"></audio>`;
                } else { // Generic file
                    htmlContent += `<div class="bg-gray-100 p-2 rounded-lg my-2 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 4a1 1 0 011-1h3a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs text-gray-700 font-medium">${mimeType} File</span>
                </div>`;
                }
            }
        }
        return htmlContent;
    }

    /**
     * H√†m th√™m tin nh·∫Øn v√†o giao di·ªán
     */
    function appendMessage(sender, content) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

        const messageBubble = document.createElement('div');
        messageBubble.className = `max-w-xs md:max-w-md p-3 shadow-md text-sm ${sender === 'user' ? 'message-user' : 'message-bot'}`;

        if (typeof content === 'string') {
            messageBubble.innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        } else if (Array.isArray(content)) {
            messageBubble.innerHTML = processMessageParts(content, sender);
        }

        messageWrapper.appendChild(messageBubble);
        chatDisplay.appendChild(messageWrapper);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
    }


    // --- LOGIC X·ª¨ L√ù ·∫¢NH (ƒê√É C·∫¨P NH·∫¨T ƒêA T·ªÜP) ---
    imageInput.addEventListener('change', async function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        uploadedImage = [];

        const maxSize = 10 * 1024 * 1024; // 5MB per image (C√≥ th·ªÉ ƒëi·ªÅu ch·ªânh, nh∆∞ng gi·ªØ an to√†n)

        try {
            removeAudioButton.click();
            removeTemplateButton.click();

            let validFilesCount = 0;
            let totalFileSize = 0;

            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    console.warn(`File ${file.name} kh√¥ng ph·∫£i l√† ·∫£nh v√† ƒë√£ b·ªã b·ªè qua.`);
                    continue;
                }
                if (file.size > maxSize) {
                    console.warn(`File ${file.name} c√≥ k√≠ch th∆∞·ªõc qu√° l·ªõn (${(file.size/1024/1024).toFixed(2)}MB) v√† ƒë√£ b·ªã b·ªè qua.`);
                    continue;
                }

                const base64Data = await fileToBase64(file);
                uploadedImage.push({
                    data: base64Data,
                    mimeType: file.type,
                    name: file.name
                });
                validFilesCount++;
                totalFileSize += file.size;
            }

            if (validFilesCount > 0) {
                imageFileName.textContent = `ƒê√£ t·∫£i l√™n ${validFilesCount} ·∫£nh (T·ªïng: ${(totalFileSize/1024/1024).toFixed(2)}MB)`;
                imagePreviewContainer.classList.remove('hidden');
            } else {
                imagePreviewContainer.classList.add('hidden');
                appendMessage('bot', 'Kh√¥ng c√≥ ·∫£nh n√†o h·ª£p l·ªá ƒë∆∞·ª£c t·∫£i l√™n. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng v√† k√≠ch th∆∞·ªõc t·ªëi ƒëa 5MB.');
            }
            userInput.focus();

        } catch (error) {
            console.error("L·ªói khi chuy·ªÉn ƒë·ªïi ·∫£nh:", error);
            appendMessage('bot', 'L·ªói: Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng ki·ªÉm tra k√≠ch th∆∞·ªõc v√† ƒë·ªãnh d·∫°ng.');
            e.target.value = null;
        }
    });

    removeImageButton.addEventListener('click', function() {
        uploadedImage = [];
        imageInput.value = null;
        imagePreviewContainer.classList.add('hidden');
    });

    // --- LOGIC X·ª¨ L√ù AUDIO (ƒê√É C·∫¨P NH·∫¨T ƒêA T·ªÜP) ---
    audioInput.addEventListener('change', async function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        uploadedAudio = [];

        const maxSize = 15 * 1024 * 1024; // 10MB per audio file (C√≥ th·ªÉ ƒëi·ªÅu ch·ªânh, nh∆∞ng gi·ªØ an to√†n)

        try {
            removeImageButton.click();
            removeTemplateButton.click();

            let validFilesCount = 0;
            let totalFileSize = 0;

            for (const file of files) {
                if (!file.type.startsWith('audio/')) {
                    console.warn(`File ${file.name} kh√¥ng ph·∫£i l√† audio v√† ƒë√£ b·ªã b·ªè qua.`);
                    continue;
                }
                if (file.size > maxSize) {
                    console.warn(`File ${file.name} c√≥ k√≠ch th∆∞·ªõc qu√° l·ªõn (${(file.size/1024/1024).toFixed(2)}MB) v√† ƒë√£ b·ªã b·ªè qua.`);
                    continue;
                }

                const base64Data = await fileToBase64(file);
                uploadedAudio.push({
                    data: base64Data,
                    mimeType: file.type,
                    name: file.name
                });
                validFilesCount++;
                totalFileSize += file.size;
            }

            if (validFilesCount > 0) {
                audioFileName.textContent = `ƒê√£ t·∫£i l√™n ${validFilesCount} audio (T·ªïng: ${(totalFileSize/1024/1024).toFixed(2)}MB)`;
                audioPreviewContainer.classList.remove('hidden');
            } else {
                audioPreviewContainer.classList.add('hidden');
                appendMessage('bot', 'Kh√¥ng c√≥ audio n√†o h·ª£p l·ªá ƒë∆∞·ª£c t·∫£i l√™n. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng v√† k√≠ch th∆∞·ªõc t·ªëi ƒëa 10MB.');
            }
            userInput.focus();

        } catch (error) {
            console.error("L·ªói khi chuy·ªÉn ƒë·ªïi audio:", error);
            appendMessage('bot', 'L·ªói: Kh√¥ng th·ªÉ t·∫£i audio. Vui l√≤ng ki·ªÉm tra k√≠ch th∆∞·ªõc v√† ƒë·ªãnh d·∫°ng.');
            e.target.value = null;
        }
    });

    removeAudioButton.addEventListener('click', function() {
        uploadedAudio = [];
        audioInput.value = null;
        audioPreviewContainer.classList.add('hidden');
    });

    // --- LOGIC X·ª¨ L√ù FILE ƒê·ªäNH D·∫†NG (TEMPLATE - ƒê√É C·∫¨P NH·∫¨T ƒêA T·ªÜP) ---
    templateInput.addEventListener('change', async function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        uploadedTemplate = [];

        const allowedMimeTypes = ['text/', 'application/json', 'application/pdf', 'audio/', 'image/'];
        const maxSize = 5 * 1024 * 1024; // 5MB per file (C√≥ th·ªÉ ƒëi·ªÅu ch·ªânh, nh∆∞ng gi·ªØ an to√†n)

        try {
            removeImageButton.click();
            removeAudioButton.click();

            let validFilesCount = 0;
            let totalFileSize = 0;

            for (const file of files) {
                const isAllowed = allowedMimeTypes.some(type => file.type.startsWith(type) || file.name.endsWith('.txt') || file.name.endsWith('.json'));

                if (!isAllowed) {
                    console.warn(`File ${file.name} c√≥ ƒë·ªãnh d·∫°ng kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ v√† ƒë√£ b·ªã b·ªè qua.`);
                    continue;
                }

                if (file.size > maxSize) {
                    console.warn(`File ${file.name} c√≥ k√≠ch th∆∞·ªõc qu√° l·ªõn (${(file.size/1024/1024).toFixed(2)}MB) v√† ƒë√£ b·ªã b·ªè qua.`);
                    continue;
                }

                const base64Data = await fileToBase64(file);

                uploadedTemplate.push({
                    data: base64Data,
                    mimeType: file.type || 'application/octet-stream',
                    name: file.name
                });
                validFilesCount++;
                totalFileSize += file.size;
            }

            if (validFilesCount > 0) {
                templateFileName.textContent = `ƒê√£ t·∫£i l√™n ${validFilesCount} file (T·ªïng: ${(totalFileSize/1024/1024).toFixed(2)}MB)`;
                templatePreviewContainer.classList.remove('hidden');
            } else {
                templatePreviewContainer.classList.add('hidden');
                appendMessage('bot', 'Kh√¥ng c√≥ file n√†o h·ª£p l·ªá ƒë∆∞·ª£c t·∫£i l√™n. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng v√† k√≠ch th∆∞·ªõc t·ªëi ƒëa 2MB.');
            }
            userInput.focus();

        } catch (error) {
            console.error("L·ªói khi chuy·ªÉn ƒë·ªïi file ƒë·ªãnh d·∫°ng:", error);
            appendMessage('bot', 'L·ªói: Kh√¥ng th·ªÉ t·∫£i file ƒë·ªãnh d·∫°ng.');
            e.target.value = null;
        }
    });

    removeTemplateButton.addEventListener('click', function() {
        uploadedTemplate = [];
        templateInput.value = null;
        templatePreviewContainer.classList.add('hidden');
    });

    // --- H√ÄM XU·∫§T CSV (EXPORT) ---
    function exportChatToCSV() {
        if (chatHistory.length === 0) {
            alert("L·ªãch s·ª≠ chat tr·ªëng. Kh√¥ng c√≥ g√¨ ƒë·ªÉ xu·∫•t.");
            return;
        }

        // ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ CSV
        let csv = 'Role,Content\n';

        chatHistory.forEach(entry => {
            const role = entry.role;
            let content = '';

            // N·ªëi t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ (text, inlineData) l·∫°i th√†nh m·ªôt chu·ªói
            entry.parts.forEach(part => {
                if (part.text) {
                    // X√≥a d·∫•u nh√°y k√©p, xu·ªëng d√≤ng, v√† c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát kh·ªèi n·ªôi dung vƒÉn b·∫£n
                    content += part.text.replace(/"/g, '""').replace(/\n/g, ' ');
                } else if (part.inlineData) {
                    // Hi·ªÉn th·ªã th√¥ng tin v·ªÅ file ƒë√≠nh k√®m
                    content += `[File: ${part.inlineData.mimeType}]`;
                }
            });

            // ƒê·∫£m b·∫£o n·ªôi dung ƒë∆∞·ª£c bao quanh b·ªüi d·∫•u nh√°y k√©p ƒë·ªÉ x·ª≠ l√Ω ng·∫Øt d√≤ng/d·∫•u ph·∫©y
            csv += `"${role}","${content}"\n`;
        });

        // T·∫°o Blob (Binary Large Object) t·ª´ chu·ªói CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

        // T·∫°o URL cho Blob
        const url = URL.createObjectURL(blob);

        // T·∫°o th·∫ª a ·∫©n ƒë·ªÉ k√≠ch ho·∫°t t·∫£i xu·ªëng
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "mrs_ai_chat_history.csv");

        // K√≠ch ho·∫°t t·∫£i xu·ªëng
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // G·∫Øn s·ª± ki·ªán cho n√∫t Export CSV
    exportButton.addEventListener('click', exportChatToCSV);


    // --- LOGIC G·ª¨I TIN NH·∫ÆN (ƒê√£ s·ª≠a l·ªói v√† c·∫≠p nh·∫≠t ƒëa t·ªáp) ---
    async function sendMessage() {
        const userMessage = userInput.value.trim();

        // 1. Ki·ªÉm tra input
        if (!userMessage && uploadedImage.length === 0 && uploadedAudio.length === 0 && uploadedTemplate.length === 0) return;

        // X·ª≠ l√Ω Time Query
        const timeKeywords = ["gi·ªù", "th·ªùi gian", "m·∫•y gi·ªù r·ªìi", "b√¢y gi·ªù l√† m·∫•y gi·ªù"];
        const isTimeQuery = timeKeywords.some(keyword => userMessage.toLowerCase().includes(keyword));

        if (isTimeQuery && uploadedImage.length === 0 && uploadedAudio.length === 0 && uploadedTemplate.length === 0) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
            });
            const dateString = now.toLocaleDateString('vi-VN', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            const botResponseText = `Gi·ªù hi·ªán t·∫°i theo h·ªá th·ªëng c·ªßa b·∫°n l√† **${timeString}** ng√†y ${dateString}.`;

            appendMessage('user', userMessage);
            appendMessage('bot', botResponseText);

            userInput.value = '';
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            return;
        }

        if (!apiKey || !apiUrl) {
            appendMessage('bot', 'üõë L·ªói c·∫•u h√¨nh: Kh√¥ng t√¨m th·∫•y Gemini API Key. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh.');
            return;
        }

        // --- Chu·∫©n b·ªã N·ªôi dung cho API ---
        const userParts = [];

        if (userMessage) {
            userParts.push({ text: userMessage });
        }

        // X·ª≠ l√Ω nhi·ªÅu file template
        if (uploadedTemplate.length > 0) {
            userParts.push({ text: `T√¥i ƒë√£ t·∫£i l√™n ${uploadedTemplate.length} file ƒë·ªãnh d·∫°ng/ƒëa ph∆∞∆°ng ti·ªán.` });
            uploadedTemplate.forEach(file => {
                userParts.push({
                    inlineData: {
                        mimeType: file.mimeType,
                        data: file.data
                    }
                });
                userParts.push({ text: `(T·ªáp ƒë√≠nh k√®m: ${file.name})` });
            });
        }

        // X·ª≠ l√Ω nhi·ªÅu ·∫£nh
        if (uploadedImage.length > 0) {
            userParts.push({ text: `T√¥i ƒë√£ t·∫£i l√™n ${uploadedImage.length} ·∫£nh.` });
            uploadedImage.forEach(image => {
                userParts.push({
                    inlineData: {
                        mimeType: image.mimeType,
                        data: image.data
                    }
                });
                userParts.push({ text: `(·∫¢nh ƒë√≠nh k√®m: ${image.name})` });
            });
        }

        // X·ª≠ l√Ω nhi·ªÅu audio
        if (uploadedAudio.length > 0) {
            userParts.push({ text: `T√¥i ƒë√£ t·∫£i l√™n ${uploadedAudio.length} audio.` });
            uploadedAudio.forEach(audio => {
                userParts.push({
                    inlineData: {
                        mimeType: audio.mimeType,
                        data: audio.data
                    }
                });
                userParts.push({ text: `(Audio ƒë√≠nh k√®m: ${audio.name})` });
            });
        }

        // 2. Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
        appendMessage('user', userParts);

        // 3. C·∫≠p nh·∫≠t l·ªãch s·ª≠ chat
        chatHistory.push({ role: "user", parts: userParts });

        // 4. Reset giao di·ªán
        userInput.value = '';
        removeImageButton.click();
        removeAudioButton.click();
        removeTemplateButton.click();

        sendButton.disabled = true;
        sendIcon.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        // 5. T·∫°o tin nh·∫Øn loading
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'flex justify-start mb-4';
        const loadingDivId = 'botLoading-' + Date.now();
        loadingMessage.innerHTML = `<div id="${loadingDivId}" class="p-3 message-bot shadow-md text-sm"><div class="spinner"></div> ƒêang ph√¢n t√≠ch...</div>`;
        chatDisplay.appendChild(loadingMessage);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;

        try {
            // System Prompt ƒë√£ ƒë∆∞·ª£c s·ª≠a ƒë·ªÉ h·ªó tr·ª£ c·∫£ H·ªèi ƒê√°p v√† Ch·∫•m ƒêi·ªÉm Media
            const systemPrompt = `B·∫°n l√† MRS AI, m·ªôt tr·ª£ l√Ω ch·∫•m ƒëi·ªÉm, ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng media v√† c≈©ng l√† m·ªôt AI tr·∫£ l·ªùi c√¢u h·ªèi th√¥ng th∆∞·ªùng.

        **Nguy√™n t·∫Øc ph·∫£n h·ªìi:**
        1. **N·∫øu ng∆∞·ªùi d√πng cung c·∫•p T·ªÜP (·∫£nh, audio, template):** B·∫°n ph·∫£i ∆∞u ti√™n ch·ª©c nƒÉng **ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng media**. D√πng th√¥ng tin t·ª´ c√°c t·ªáp ƒë√≠nh k√®m (nh∆∞ ti√™u ch√≠, thang ƒëi·ªÉm, c·∫•u tr√∫c trong t·ªáp .txt, .json, .pdf) ƒë·ªÉ ph√¢n t√≠ch v√† ƒë√°nh gi√° t·ªáp media (·∫£nh/audio). ƒê∆∞a ra k·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm theo thang ƒëi·ªÉm 10 v√† gi·∫£i th√≠ch ng·∫Øn g·ªçn l√Ω do t·∫°i sao.
        2. **N·∫øu ng∆∞·ªùi d√πng CH·ªà h·ªèi c√¢u h·ªèi chung (kh√¥ng c√≥ t·ªáp):** B·∫°n ph·∫£i ho·∫°t ƒë·ªông nh∆∞ m·ªôt AI tr·∫£ l·ªùi c√¢u h·ªèi th√¥ng th∆∞·ªùng. S·ª≠ d·ª•ng ki·∫øn th·ª©c v√† c√¥ng c·ª• t√¨m ki·∫øm c·ªßa m√¨nh (Google Search) ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi m·ªôt c√°ch ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c.

        S·ª≠ d·ª•ng ti·∫øng Vi·ªát, th√¢n thi·ªán v√† chuy√™n nghi·ªáp.`;

            const payload = {
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            let botResponseText = "Xin l·ªói, ƒë√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.";
            let lastError = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorDetail = `API call failed with status ${response.status}. Error: ${errorData.error ? errorData.error.message : 'Unknown'}`;
                        throw new Error(errorDetail);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        botResponseText = candidate.content.parts[0].text;
                        break;
                    }
                    throw new Error("API response structure is invalid or content is missing.");

                } catch (error) {
                    lastError = error;
                    console.error(`L·ªói l·∫ßn th·ª≠ ${i + 1}:`, error.message);
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (botResponseText === "Xin l·ªói, ƒë√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.") {
                botResponseText = `Xin l·ªói, kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn d·ªãch v·ª• sau ${maxRetries} l·∫ßn th·ª≠. Vui l√≤ng th·ª≠ l·∫°i sau. (L·ªói cu·ªëi c√πng: ${lastError ? lastError.message : 'Kh√¥ng r√µ'})`;
            }


            // 7. X√≥a tin nh·∫Øn loading
            const loadingDiv = document.getElementById(loadingDivId);
            if (loadingDiv) loadingDiv.parentElement.remove();

            // 8. Hi·ªÉn th·ªã tin nh·∫Øn ph·∫£n h·ªìi
            appendMessage('bot', botResponseText);

            // 9. C·∫≠p nh·∫≠t l·ªãch s·ª≠ chat
            chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });

        } catch (error) {
            console.error("L·ªói x·ª≠ l√Ω chat nghi√™m tr·ªçng:", error);
            const loadingDiv = document.getElementById(loadingDivId);
            if (loadingDiv) loadingDiv.parentElement.remove();
            appendMessage('bot', `ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng: ${error.message}. Vui l√≤ng ki·ªÉm tra console.`);
        } finally {
            // 10. Ph·ª•c h·ªìi tr·∫°ng th√°i
            sendButton.disabled = false;
            sendIcon.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            userInput.focus();
        }
    }

    // G·∫Øn s·ª± ki·ªán cho n√∫t G·ª≠i
    sendButton.addEventListener('click', sendMessage);

    // G·∫Øn s·ª± ki·ªán cho ph√≠m Enter
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // T·ª± ƒë·ªông focus v√†o input khi t·∫£i trang
    window.onload = () => {
        userInput.focus();
    };
</script>

</body>
</html>