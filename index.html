<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRS AI</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        h1 {
            color: #003366;
        }
        p{
            color: #003366;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            background-image: url("Screenshot_20250618_200427_Drive.jpg");
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-position: center top;
            background-size: 120px 60px;
        }
        .chat-container {
            max-width: 800px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        #chatDisplay {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        #userInputContainer {
            padding: 1rem;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 0.75rem 0.75rem;
        }
        .message-user {
            background-color: #FF9933; /* Blue 600 */
            color: white;
            border-radius: 0.75rem 0.75rem 0 0.75rem;
        }
        .message-bot {
            background-color: #EEEEEE; /* Gray 200 */
            color: #666666; /* Gray 800 */
            border-radius: 0.75rem 0.75rem 0.75rem 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style cho n√∫t T·∫£i file */
        .file-input-label {
            cursor: pointer;
            transition: all 0.15s;
        }
        .file-input-label:hover {
            color: #1d4ed8; /* Blue 700 */
        }
        </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

<div class="chat-container w-full rounded-xl">

    <!-- Header -->
    <div class="p-4 bg-orange-600 text-white rounded-t-xl text-center">
        <h1 class="text-xl font-bold" >MRS AI</h1>
        <p class="text-sm opacity-80">K·∫øt n·ªëi nhanh ‚Äì Gi·∫£i ƒë√°p chu·∫©n ‚Äì Tr·∫£i nghi·ªám th√¥ng minh c√πng MRS AI</p>
    </div>

    <!-- Khu v·ª±c hi·ªÉn th·ªã chat -->
    <div id="chatDisplay">
        <!-- Tin nh·∫Øn ch√†o m·ª´ng -->
        <div class="flex justify-start mb-4">
            <div class="max-w-xs md:max-w-md p-3 message-bot">
                Ch√†o b·∫°n! R·∫•t vui ƒë∆∞·ª£c n√≥i chuy·ªán v·ªõi b·∫°n. B·∫°n mu·ªën m√¨nh gi√∫p g√¨ h√¥m nay?
            </div>
        </div>
    </div>

    <!-- Khu v·ª±c hi·ªÉn th·ªã ·∫£nh ƒë√£ t·∫£i l√™n -->
    <div id="imagePreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3">
                <img id="imagePreview" class="h-10 w-10 object-cover rounded-md" src="" alt="·∫¢nh t·∫£i l√™n">
                <span class="text-sm text-gray-700 font-medium">·∫¢nh ƒë√£ t·∫£i l√™n</span>
            </div>
            <button id="removeImageButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Khu v·ª±c hi·ªÉn th·ªã audio ƒë√£ t·∫£i l√™n (M·ªöI) -->
    <div id="audioPreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3 w-full">
                <audio id="audioPreview" controls class="flex-grow h-10"></audio>
            </div>
            <button id="removeAudioButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors ml-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>


    <!-- Khu v·ª±c nh·∫≠p li·ªáu -->
    <div id="templatePreviewContainer" class="p-3 bg-gray-50 border-t border-gray-200 hidden">
        <div class="flex items-center justify-between p-2 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center space-x-3 w-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span id="templateFileName" class="text-sm text-gray-700 font-medium truncate flex-grow">T√™n file ƒë·ªãnh d·∫°ng.txt</span>
            </div>
            <button id="removeTemplateButton" class="p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors ml-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div id="userInputContainer" class="flex items-end">

        <div class="p-3">
            <input type="file" id="templateInput" accept=".txt,.json,.pdf,audio/*,image/*" class="hidden">
            <label for="templateInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </label>
        </div>
        <!-- N√∫t T·∫£i ·∫£nh -->
        <div class="p-3">
            <input type="file" id="imageInput" accept="image/*" class="hidden">
            <label for="imageInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center">
                <!-- Icon T·∫£i ·∫£nh (Clip gi·∫•y) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13.5" />
                </svg>
            </label>
        </div>

        <!-- N√∫t T·∫£i Audio (M·ªöI) -->
        <div class="p-3">
            <input type="file" id="audioInput" accept="audio/*" class="hidden">
            <label for="audioInput" class="file-input-label text-gray-500 p-2 rounded-full flex items-center justify-center">
                <!-- Icon Micro/Audio -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7v1a3 3 0 01-6 0v-1a7 7 0 01-7-7h1a6 6 0 0012 0h1z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18V3" />
                </svg>
            </label>
        </div>

        <input type="text" id="userInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
               class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">

        <button id="sendButton" class="ml-3 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center">
            <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
            <div id="loadingSpinner" class="spinner hidden"></div>
        </button>
    </div>
</div>

<script>
    // KH√ìA API CUNG C·∫§P B·ªûI NG∆Ø·ªúI D√ôNG.
    const USER_PROVIDED_API_KEY = "AIzaSyDQriDXZlI6XNVn91cyoFUyz1xSkBhJ0VA";

    // L·∫•y API Key: ∆Øu ti√™n bi·∫øn m√¥i tr∆∞·ªùng Canvas, n·∫øu kh√¥ng c√≥ th√¨ d√πng kh√≥a do ng∆∞·ªùi d√πng cung c·∫•p.
    let apiKey = (typeof __initial_gemini_api_key !== 'undefined')
        ? __initial_gemini_api_key
        : USER_PROVIDED_API_KEY; // S·ª≠ d·ª•ng kh√≥a do ng∆∞·ªùi d√πng cung c·∫•p.

    let apiUrl = apiKey
        ? `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`
        : null;

    // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
    const chatDisplay = document.getElementById('chatDisplay');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const sendIcon = document.getElementById('sendIcon');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Ph·∫ßn t·ª≠ ·∫¢nh
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImageButton = document.getElementById('removeImageButton');

    // Ph·∫ßn t·ª≠ Audio
    const audioInput = document.getElementById('audioInput');
    const audioPreviewContainer = document.getElementById('audioPreviewContainer');
    const audioPreview = document.getElementById('audioPreview');
    const removeAudioButton = document.getElementById('removeAudioButton');

    // PH·∫¶N T·ª¨ M·ªöI CHO FILE ƒê·ªäNH D·∫†NG (TEMPLATE)
    const templateInput = document.getElementById('templateInput');
    const templatePreviewContainer = document.getElementById('templatePreviewContainer');
    const templateFileName = document.getElementById('templateFileName');
    const removeTemplateButton = document.getElementById('removeTemplateButton');

    let chatHistory = [];
    let uploadedImage = {
        data: null,
        mimeType: null,
        url: null
    };
    let uploadedAudio = {
        data: null,
        mimeType: null,
        url: null
    };
    let uploadedTemplate = {
        data: null,
        mimeType: null,
        name: null
    };

    /**
     * Chuy·ªÉn ƒë·ªïi Blob/File th√†nh chu·ªói Base64.
     * @param {File} file - File ·∫£nh, audio ho·∫∑c template ƒë∆∞·ª£c t·∫£i l√™n.
     * @returns {Promise<string>} Chu·ªói Base64 data (ch·ªâ data, kh√¥ng c√≥ prefix).
     */
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                // Lo·∫°i b·ªè ph·∫ßn prefix "data:image/jpeg;base64,"
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    /**
     * H√†m hi·ªÉn th·ªã n·ªôi dung media (n·∫øu c√≥) trong tin nh·∫Øn.
     * @param {object[]} parts - M·∫£ng c√°c ph·∫ßn n·ªôi dung (text, inlineData).
     * @returns {string} HTML string ch·ª©a ·∫£nh, audio, file (ho·∫∑c text ƒë√£ ƒë∆∞·ª£c format).
     */
    function processMessageParts(parts, sender) {
        let htmlContent = '';
        for (const part of parts) {
            if (part.text) {
                let text = part.text;
                if (sender === 'bot') {
                    // X·ª≠ l√Ω markdown ƒë∆°n gi·∫£n cho ph·∫£n h·ªìi c·ªßa bot
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/\n/g, '<br>');
                }
                htmlContent += text;
            } else if (part.inlineData) {
                const mimeType = part.inlineData.mimeType;
                const fileUrl = `data:${mimeType};base64,${part.inlineData.data}`;

                if (mimeType.startsWith('image/')) {
                    // Hi·ªÉn th·ªã ·∫£nh
                    htmlContent += `<img src="${fileUrl}" alt="Uploaded Image" class="max-w-full h-auto max-h-48 object-contain rounded-lg my-2 border border-gray-300 shadow-md">`;
                } else if (mimeType.startsWith('audio/')) {
                    // Hi·ªÉn th·ªã audio
                    htmlContent += `<audio controls src="${fileUrl}" class="w-full my-2 rounded-lg"></audio>`;
                } else {
                    // Hi·ªÉn th·ªã file template d∆∞·ªõi d·∫°ng tag
                    htmlContent += `<div class="bg-gray-100 p-2 rounded-lg my-2 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 4a1 1 0 011-1h3a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0 3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs text-gray-700 font-medium">${mimeType} File</span>
                </div>`;
                }
            }
        }
        return htmlContent;
    }

    /**
     * H√†m th√™m tin nh·∫Øn v√†o giao di·ªán
     * @param {string} sender - 'user' ho·∫∑c 'bot'
     * @param {string | object[]} content - N·ªôi dung vƒÉn b·∫£n ho·∫∑c m·∫£ng parts
     */
    function appendMessage(sender, content) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

        const messageBubble = document.createElement('div');
        messageBubble.className = `max-w-xs md:max-w-md p-3 shadow-md text-sm ${sender === 'user' ? 'message-user' : 'message-bot'}`;

        if (typeof content === 'string') {
            // Tin nh·∫Øn ch√†o m·ª´ng ho·∫∑c l·ªói
            messageBubble.innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        } else if (Array.isArray(content)) {
            // Tin nh·∫Øn t·ª´ l·ªãch s·ª≠ chat (bao g·ªìm c·∫£ ·∫£nh/audio/template)
            messageBubble.innerHTML = processMessageParts(content, sender);
        }

        messageWrapper.appendChild(messageBubble);
        chatDisplay.appendChild(messageWrapper);
        chatDisplay.scrollTop = chatDisplay.scrollHeight; // Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
    }


    // --- LOGIC X·ª¨ L√ù ·∫¢NH ---
    imageInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            appendMessage('bot', 'L·ªói: Vui l√≤ng ch·ªçn m·ªôt file h√¨nh ·∫£nh.');
            return;
        }
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            appendMessage('bot', 'L·ªói: K√≠ch th∆∞·ªõc file ·∫£nh qu√° l·ªõn (t·ªëi ƒëa 5MB).');
            return;
        }

        try {
            removeAudioButton.click();
            removeTemplateButton.click();

            const base64Data = await fileToBase64(file);
            const imageUrl = URL.createObjectURL(file);

            uploadedImage.data = base64Data;
            uploadedImage.mimeType = file.type;
            uploadedImage.url = imageUrl;

            imagePreview.src = imageUrl;
            imagePreviewContainer.classList.remove('hidden');
            userInput.focus();

        } catch (error) {
            console.error("L·ªói khi chuy·ªÉn ƒë·ªïi ·∫£nh:", error);
            appendMessage('bot', 'L·ªói: Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng ki·ªÉm tra k√≠ch th∆∞·ªõc v√† ƒë·ªãnh d·∫°ng.');
            e.target.value = null;
        }
    });
    removeImageButton.addEventListener('click', function() {
        if (uploadedImage.url) {
            URL.revokeObjectURL(uploadedImage.url);
        }
        uploadedImage.data = null;
        uploadedImage.mimeType = null;
        uploadedImage.url = null;
        imageInput.value = null;
        imagePreviewContainer.classList.add('hidden');
    });

    // --- LOGIC X·ª¨ L√ù AUDIO ---
    audioInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('audio/')) {
            appendMessage('bot', 'L·ªói: Vui l√≤ng ch·ªçn m·ªôt file audio.');
            return;
        }

        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            appendMessage('bot', 'L·ªói: K√≠ch th∆∞·ªõc file audio qu√° l·ªõn (t·ªëi ƒëa 10MB).');
            return;
        }

        try {
            removeImageButton.click();
            removeTemplateButton.click();

            const base64Data = await fileToBase64(file);
            const audioUrl = URL.createObjectURL(file);

            uploadedAudio.data = base64Data;
            uploadedAudio.mimeType = file.type;
            uploadedAudio.url = audioUrl;

            audioPreview.src = audioUrl;
            audioPreviewContainer.classList.remove('hidden');
            userInput.focus();

        } catch (error) {
            console.error("L·ªói khi chuy·ªÉn ƒë·ªïi audio:", error);
            appendMessage('bot', 'L·ªói: Kh√¥ng th·ªÉ t·∫£i audio. Vui l√≤ng ki·ªÉm tra k√≠ch th∆∞·ªõc v√† ƒë·ªãnh d·∫°ng.');
            e.target.value = null;
        }
    });
    removeAudioButton.addEventListener('click', function() {
        if (uploadedAudio.url) {
            URL.revokeObjectURL(uploadedAudio.url);
        }
        uploadedAudio.data = null;
        uploadedAudio.mimeType = null;
        uploadedAudio.url = null;
        audioInput.value = null;
        audioPreview.pause();
        audioPreviewContainer.classList.add('hidden');
    });

    // --- LOGIC X·ª¨ L√ù FILE ƒê·ªäNH D·∫†NG (TEMPLATE) ---
    templateInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const allowedMimeTypes = ['text/', 'application/json', 'application/pdf', 'audio/', 'image/'];
        const isAllowed = allowedMimeTypes.some(type => file.type.startsWith(type) || file.name.endsWith('.txt') || file.name.endsWith('.json'));

        if (!isAllowed) {
            appendMessage('bot', 'L·ªói: ƒê·ªãnh d·∫°ng file ƒë·ªãnh d·∫°ng kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ (ch·ªâ ch·∫•p nh·∫≠n Text, JSON, PDF, Audio, Image).');
            return;
        }

        const maxSize = 2 * 1024 * 1024;
        if (file.size > maxSize) {
            appendMessage('bot', 'L·ªói: K√≠ch th∆∞·ªõc file ƒë·ªãnh d·∫°ng qu√° l·ªõn (t·ªëi ƒëa 2MB).');
            return;
        }

        try {
            removeImageButton.click();
            removeAudioButton.click();

            const base64Data = await fileToBase64(file);

            uploadedTemplate.data = base64Data;
            uploadedTemplate.mimeType = file.type;
            uploadedTemplate.name = file.name;

            templateFileName.textContent = file.name;
            templatePreviewContainer.classList.remove('hidden');
            userInput.focus();

        } catch (error) {
            console.error("L·ªói khi chuy·ªÉn ƒë·ªïi file ƒë·ªãnh d·∫°ng:", error);
            appendMessage('bot', 'L·ªói: Kh√¥ng th·ªÉ t·∫£i file ƒë·ªãnh d·∫°ng.');
            e.target.value = null;
        }
    });
    removeTemplateButton.addEventListener('click', function() {
        uploadedTemplate.data = null;
        uploadedTemplate.mimeType = null;
        uploadedTemplate.name = null;
        templateInput.value = null;
        templatePreviewContainer.classList.add('hidden');
    });


    // --- LOGIC G·ª¨I TIN NH·∫ÆN (ƒê√£ s·ª≠a l·ªói) ---
    async function sendMessage() {
        const userMessage = userInput.value.trim();

        // 1. Ki·ªÉm tra input
        if (!userMessage && !uploadedImage.data && !uploadedAudio.data && !uploadedTemplate.data) return;

        // X·ª≠ l√Ω Time Query (ƒê√£ s·ª≠a l·ªói g·ªçi h√†m appendMessage)
        const timeKeywords = ["gi·ªù", "th·ªùi gian", "m·∫•y gi·ªù r·ªìi", "b√¢y gi·ªù l√† m·∫•y gi·ªù"];
        const isTimeQuery = timeKeywords.some(keyword => userMessage.toLowerCase().includes(keyword));

        if (isTimeQuery && !uploadedImage.data && !uploadedAudio.data && !uploadedTemplate.data) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
            });
            const dateString = now.toLocaleDateString('vi-VN', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            const botResponseText = `Gi·ªù hi·ªán t·∫°i theo h·ªá th·ªëng c·ªßa b·∫°n l√† **${timeString}** ng√†y ${dateString}.`;

            // G·ªåI H√ÄM appendMessage ƒê√É ƒê·ªäNH NGHƒ®A ·ªû TR√äN
            appendMessage('user', userMessage);
            appendMessage('bot', botResponseText);

            userInput.value = '';
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            return;
        }

        if (!apiKey || !apiUrl) {
            appendMessage('bot', 'üõë L·ªói c·∫•u h√¨nh: Kh√¥ng t√¨m th·∫•y Gemini API Key. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh.');
            return;
        }

        // --- Chu·∫©n b·ªã N·ªôi dung cho API ---
        const userParts = [];

        if (userMessage) {
            userParts.push({ text: userMessage });
        }

        if (uploadedTemplate.data && uploadedTemplate.mimeType) {
            userParts.push({
                inlineData: {
                    mimeType: uploadedTemplate.mimeType,
                    data: uploadedTemplate.data
                }
            });
            userParts.push({ text: `ƒê√¢y l√† file ƒë·ªãnh d·∫°ng c√≥ t√™n "${uploadedTemplate.name}" m√† t√¥i mu·ªën b·∫°n d√πng ƒë·ªÉ ƒë√°nh gi√°/ch·∫•m ƒëi·ªÉm t·ªáp media sau.` });
        }

        if (uploadedImage.data && uploadedImage.mimeType) {
            userParts.push({
                inlineData: {
                    mimeType: uploadedImage.mimeType,
                    data: uploadedImage.data
                }
            });
        }

        if (uploadedAudio.data && uploadedAudio.mimeType) {
            userParts.push({
                inlineData: {
                    mimeType: uploadedAudio.mimeType,
                    data: uploadedAudio.data
                }
            });
        }

        // 2. Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
        appendMessage('user', userParts);

        // 3. C·∫≠p nh·∫≠t l·ªãch s·ª≠ chat
        chatHistory.push({ role: "user", parts: userParts });

        // 4. Reset giao di·ªán
        userInput.value = '';
        removeImageButton.click();
        removeAudioButton.click();
        removeTemplateButton.click();

        sendButton.disabled = true;
        sendIcon.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        // 5. T·∫°o tin nh·∫Øn loading
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'flex justify-start mb-4';
        const loadingDivId = 'botLoading-' + Date.now();
        loadingMessage.innerHTML = `<div id="${loadingDivId}" class="p-3 message-bot shadow-md text-sm"><div class="spinner"></div> ƒêang ph√¢n t√≠ch...</div>`;
        chatDisplay.appendChild(loadingMessage);
        chatDisplay.scrollTop = chatDisplay.scrollHeight;

        try {
            const systemPrompt = `B·∫°n l√† MRS AI, m·ªôt tr·ª£ l√Ω ch·∫•m ƒëi·ªÉm v√† ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng media.
        N·∫øu ng∆∞·ªùi d√πng t·∫£i l√™n m·ªôt t·ªáp media (·∫£nh/audio) k√®m theo m·ªôt t·ªáp ƒë·ªãnh d·∫°ng (template), h√£y s·ª≠ d·ª•ng th√¥ng tin trong t·ªáp ƒë·ªãnh d·∫°ng ƒë√≥ (v√≠ d·ª•: ti√™u ch√≠, thang ƒëi·ªÉm, c·∫•u tr√∫c) ƒë·ªÉ ph√¢n t√≠ch v√† ƒë√°nh gi√° t·ªáp media.
        ƒê∆∞a ra k·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm theo thang ƒëi·ªÉm 10 v√† gi·∫£i th√≠ch ng·∫Øn g·ªçn l√Ω do t·∫°i sao.
        S·ª≠ d·ª•ng ti·∫øng Vi·ªát, th√¢n thi·ªán v√† chuy√™n nghi·ªáp.`;

            const payload = {
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            let botResponseText = "Xin l·ªói, ƒë√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.";
            let lastError = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorDetail = `API call failed with status ${response.status}. Error: ${errorData.error ? errorData.error.message : 'Unknown'}`;
                        throw new Error(errorDetail);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        botResponseText = candidate.content.parts[0].text;
                        break;
                    }
                    throw new Error("API response structure is invalid or content is missing.");

                } catch (error) {
                    lastError = error;
                    console.error(`L·ªói l·∫ßn th·ª≠ ${i + 1}:`, error.message);
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (botResponseText === "Xin l·ªói, ƒë√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.") {
                botResponseText = `Xin l·ªói, kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn d·ªãch v·ª• sau ${maxRetries} l·∫ßn th·ª≠. Vui l√≤ng th·ª≠ l·∫°i sau. (L·ªói cu·ªëi c√πng: ${lastError ? lastError.message : 'Kh√¥ng r√µ'})`;
            }


            // 7. X√≥a tin nh·∫Øn loading
            const loadingDiv = document.getElementById(loadingDivId);
            if (loadingDiv) loadingDiv.parentElement.remove();

            // 8. Hi·ªÉn th·ªã tin nh·∫Øn ph·∫£n h·ªìi
            appendMessage('bot', botResponseText);

            // 9. C·∫≠p nh·∫≠t l·ªãch s·ª≠ chat
            chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });

        } catch (error) {
            console.error("L·ªói x·ª≠ l√Ω chat nghi√™m tr·ªçng:", error);
            const loadingDiv = document.getElementById(loadingDivId);
            if (loadingDiv) loadingDiv.parentElement.remove();
            appendMessage('bot', `ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng: ${error.message}. Vui l√≤ng ki·ªÉm tra console.`);
        } finally {
            // 10. Ph·ª•c h·ªìi tr·∫°ng th√°i
            sendButton.disabled = false;
            sendIcon.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            userInput.focus();
        }
    }

    // G·∫Øn s·ª± ki·ªán cho n√∫t G·ª≠i
    sendButton.addEventListener('click', sendMessage);

    // G·∫Øn s·ª± ki·ªán cho ph√≠m Enter
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // T·ª± ƒë·ªông focus v√†o input khi t·∫£i trang
    window.onload = () => {
        userInput.focus();
    };
</script>

</body>
</html>
